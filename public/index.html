<!doctype html>
<html lang="en">
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta charset="utf-8">
	<title>Game of Thrones - Best Episodes</title>
	<link rel="stylesheet" href="/css/w3.css" type="text/css">
	<script src = "https://ajax.googleapis.com/ajax/libs/angularjs/1.3.3/angular.min.js"></script>
	<link href='https://fonts.googleapis.com/css?family=Abel' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
	<link rel="stylesheet" href="/css/style.css">
	<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
</head>
<body ng-app="episodesApp" ng-controller="episodesController">

	<div class="w3-container" id="page">

		<!-- <img src="/images/bg.jpg" style="visibility: hidden" > -->
		<div class="w3-row " id="topHalf">

			<div class="w3-row smallerSmall">
				<div class="w3-col w3-container">
					<div id="reloadButton" type="button" class="w3-right" ng-click="recharger()"><i class="fa fa-refresh" ></i></div>
				</div>

			</div>

			<div class="w3-row">
				<div class="w3-third m2 w3-hide-small ">&nbsp;</div>
				<div class="w3-third m8 s12" id="panneau"><h1>Game of Thrones</h1><p>best episodes</p></div>
				<div class="w3-third m2 w3-hide-small">&nbsp;</div>
			</div>


			<div class="w3-row smallerSmall" >
				
			</div>


		</div>

		<div class="w3-row" id="bottomHalf">
			<div class="w3-col l6 m12 s12">
				<div><span id="season">Season</span><br class="w3-hide-small w3-hide-medium"><span id="seasonNo">6</span></div>
			</div>

			<div class="w3-col l6 w3-container s12 m12 w3-padding"  >
				<div class="w3-row" ng-repeat="ep in episodes" data-id="{{ep.id}}">
					<div class=" w3-container w3-col l4 m3 s7">{{ep.title}}<br><span class="duration">{{ep.durationMsg}}</span></div>
					<div class="w3-col l1 m1 s1 souligne w3-container">&nbsp;</div>
					<div class="l3 s2 w3-col likeCol">{{ep.like}} &nbsp;&nbsp;</div>
					<div class="l2 w3-col s1"><span class="w3-circle" ng-click="augmenter(ep)" ><i class="fa fa-thumbs-up" aria-hidden="true" data-></i><span></div>

				</div>
			</div>

		</div>
	</div>


	<script>

		var episodeIds = [];


		var episodesApp = angular.module('episodesApp',[]);

		episodesApp.controller('episodesController', function($http, $scope) {

			

			$http.get('/episodes').success(function(response) {
				var res = response;
				res.forEach(function(elt, index, tab) {
					var s = +elt.duration;
					elt.durationMsg = Math.round(s/60) + "min " + (s%60) + " sec";
					elt.liked = false;
					episodeIds.push(elt.id);
					
				});
				$scope.episodes = res;
				$scope.recharger();
			});
			$scope.augmenter = function(ep) {
				if(!ep.liked) {
					ep.like = (+ep.like)+1;
					ep.liked=true;
					console.log(ep);
					window.localStorage['got_episode_' + ep.id +'_like'] = ep.like;
				}
			};

			$scope.recharger = function() {
				console.log("recharger called " + $scope.episodes.length + ' mit ' + window.localStorage.getItem('gotTabNum'));
				$scope.episodes.forEach(function(elt, index, tab) {
					var like = window.localStorage['got_episode_' + elt.id + '_like' ];
					if(like) {
						elt.like = like;
					}
				});	
			};


			


		});

	
		/* Augmenter le compteur d'onglets au chargmeent */
		window.addEventListener('load',function(e) {
			if(!localStorage.getItem('gotTabNum') || localStorage.getItem('gotTabNum') < 0) {
				//console.log('a novueau');
				localStorage.setItem('gotTabNum', 1);
				//alert('a nouveau ' + localStorage.getItem('gotTabNum'));
			} else {
				var n = +localStorage.getItem('gotTabNum');
				//window.alert('me window ' + n);
				localStorage.setItem('gotTabNum', (n+1) );
			}
		});		



		
		/* Si le nombre d'onglets <= 0, effacer localStorage : le compteur et les likes */
		$(window).unload(function() {
			//console.log('zzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzzz');
			//console.log(+window.localStorage.getItem('gotTabNum'));			
			window.localStorage.setItem('gotTabNum', +window.localStorage.getItem('gotTabNum') - 1);
			//console.log(+window.localStorage.getItem('gotTabNum'));			
			//console.log('over');
			if(+window.localStorage.getItem('gotTabNum') <= 0) {
				
				localStorage.clear();
			}
		});

	</script>


</body>
</html>